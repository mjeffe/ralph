#!/bin/bash
# Ralph Wiggum Loop - Entry Point Script
# 
# Usage:
#   ./ralph              # Build mode, unlimited iterations
#   ./ralph 20           # Build mode, max 20 iterations
#   ./ralph plan         # Plan mode, interactive session
#   ./ralph plan feature # Plan mode with spec name hint

set -e

# Resolve script location and project root
# Use readlink to resolve symlinks to the actual script location
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Change to project root - all operations happen from here
cd "$PROJECT_ROOT"

# Validate Ralph installation structure
if [ ! -d "$PROJECT_ROOT/.ralph" ]; then
    echo -e "\033[0;31mError: Invalid Ralph installation: .ralph/ directory not found\033[0m" >&2
    exit 1
fi

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}Warning: $1${NC}" >&2
}

info() {
    echo -e "${GREEN}$1${NC}"
}

# Check prerequisites
check_prerequisites() {
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        error "Not a git repository. Run 'git init' first."
    fi

    # Check if loop.sh exists
    if [ ! -f ".ralph/loop.sh" ]; then
        error ".ralph/loop.sh not found"
    fi

    # Check if loop.sh is executable
    if [ ! -x ".ralph/loop.sh" ]; then
        warn ".ralph/loop.sh is not executable, making it executable..."
        chmod +x .ralph/loop.sh
    fi

    # Check if cline is available
    if ! command -v cline &> /dev/null; then
        error "cline command not found. Please install cline CLI."
    fi

    # Check if specs/ directory exists
    if [ ! -d "specs" ]; then
        error "specs/ directory not found. Create it and add at least one specification."
    fi

    # Check if specs/ has any files
    if [ -z "$(ls -A specs/*.md 2>/dev/null)" ]; then
        error "No specification files found in specs/. Add at least one .md file."
    fi
}

# Initialize Ralph in a project
ralph_init() {
    echo ""
    info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    info "Ralph Initialization"
    info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        error "Not a git repository. Run 'git init' first."
    fi
    
    # Check if .ralph/ directory exists
    if [ ! -d ".ralph" ]; then
        error ".ralph/ directory not found. Ralph may not be installed.\nRun the installation script first."
    fi
    
    # Create specs/ directory if it doesn't exist
    if [ ! -d "specs" ]; then
        mkdir -p specs
        info "Created specs/ directory"
    else
        echo "✓ specs/ directory already exists"
    fi
    
    # Create specs/README.md if it doesn't exist
    if [ ! -f "specs/README.md" ]; then
        cat > specs/README.md << 'EOF'
# Specification Index

## Active Specifications

(No specifications yet - create your first spec)

## How to Create Specs

1. Create a new file: `specs/feature-name.md`
2. Document requirements, use cases, and success criteria
3. Run Ralph build loop: `.ralph/ralph`

See `.ralph/docs/` for detailed guidance on writing specifications.
EOF
        info "Created specs/README.md"
    else
        echo "✓ specs/README.md already exists"
    fi
    
    # Handle AGENTS.md
    if [ ! -f "AGENTS.md" ]; then
        # Create AGENTS.md from template
        if [ -f ".ralph/AGENTS.md.template" ]; then
            cp .ralph/AGENTS.md.template AGENTS.md
            info "Created AGENTS.md from template"
        else
            warn "Template not found: .ralph/AGENTS.md.template"
        fi
    else
        # AGENTS.md already exists - show informational message
        echo ""
        warn "Found existing AGENTS.md"
        echo ""
        echo "Ralph requires a \"## Specifications\" section in AGENTS.md for proper operation."
        echo "This section tells agents to consult specs/README.md before implementing features."
        echo ""
        echo "Please add this section to your AGENTS.md if it's not already present."
        echo "You can review the full template at: .ralph/AGENTS.md.template"
        echo ""
    fi
    
    # Display success message and next steps
    echo ""
    info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    info "Initialization complete!"
    info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Next steps:"
    echo ""
    echo "  1. (Optional) Create a convenience symlink:"
    echo "     ln -s .ralph/ralph ralph"
    echo "     Then you can run: ./ralph from anywhere in your repo"
    echo ""
    echo "  2. Read the documentation:"
    echo "     .ralph/docs/README.md"
    echo ""
    echo "  3. Create your first specification:"
    echo "     Edit specs/my-feature.md with your requirements"
    echo ""
    echo "  4. Start the build loop:"
    echo "     .ralph/ralph"
    echo ""
    echo "Documentation: .ralph/docs/"
    echo ""
    
    exit 0
}

# Show usage information
show_usage() {
    cat << EOF
Ralph Wiggum Loop - Iterative Development System

Usage:
  ./ralph              Run build loop, unlimited iterations
  ./ralph <N>          Run build loop, max N iterations
  ./ralph init         Initialize Ralph in current project

Examples:
  ./ralph              Run build loop until PROJECT_COMPLETE
  ./ralph 10           Run build loop for max 10 iterations
  ./ralph init         Set up specs/ and AGENTS.md

Description:
  Ralph runs an autonomous loop that implements tasks from IMPLEMENTATION_PLAN.md
  First iteration creates IMPLEMENTATION_PLAN.md if it doesn't exist
  
  Specifications should be created manually or with any tool you prefer:
  - Manual editing in specs/
  - cline --plan directly
  - ChatGPT, Claude, or any AI assistant

EOF
    exit 0
}

# Parse arguments
MAX_ITERATIONS=0

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_usage
fi

if [ "$1" = "init" ]; then
    ralph_init
fi

if [[ "$1" =~ ^[0-9]+$ ]]; then
    MAX_ITERATIONS=$1
elif [ -n "$1" ]; then
    error "Invalid argument: $1\nUse './ralph --help' for usage information"
fi

# Run prerequisite checks
check_prerequisites

# Display startup information
echo ""
info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
info "Ralph Wiggum Loop"
info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if [ $MAX_ITERATIONS -gt 0 ]; then
    echo "Max iterations: $MAX_ITERATIONS"
fi
echo "Branch: $(git branch --show-current)"
info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Delegate to loop.sh
if [ $MAX_ITERATIONS -gt 0 ]; then
    exec .ralph/loop.sh "$MAX_ITERATIONS"
else
    exec .ralph/loop.sh
fi
